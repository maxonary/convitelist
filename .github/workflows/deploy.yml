name: Build and Test

permissions:
  contents: read

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.12.0'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Verify Node.js version
        run: node --version

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci --legacy-peer-deps

      - name: Run backend tests
        working-directory: ./backend
        run: npm run test:unit

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test -- --run

  # build:
  #   name: Build Docker Images
  #   runs-on: ubuntu-latest
  #   needs: test
  #   if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Log in to Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ env.REGISTRY }}
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Extract metadata for backend
  #       id: meta-backend
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
  #         tags: |
  #           type=ref,event=branch
  #           type=sha,prefix={{branch}}-
  #           type=raw,value=latest,enable={{is_default_branch}}

  #     - name: Build and push backend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./backend
  #         push: true
  #         tags: ${{ steps.meta-backend.outputs.tags }}
  #         labels: ${{ steps.meta-backend.outputs.labels }}
  #         cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache
  #         cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:buildcache,mode=max

  #     - name: Extract metadata for frontend
  #       id: meta-frontend
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
  #         tags: |
  #           type=ref,event=branch
  #           type=sha,prefix={{branch}}-
  #           type=raw,value=latest,enable={{is_default_branch}}

  #     - name: Set frontend build args defaults
  #       run: |
  #         echo "REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:3001}" >> $GITHUB_ENV
  #         echo "REACT_APP_STATUS_API_URL=${REACT_APP_STATUS_API_URL:-http://localhost:5000}" >> $GITHUB_ENV
  #         echo "REACT_APP_SERVER_STATUS_URL=${REACT_APP_SERVER_STATUS_URL:-http://localhost:5000}" >> $GITHUB_ENV
  #         echo "REACT_APP_SERVER_NAME=${REACT_APP_SERVER_NAME:-Minecraft Server}" >> $GITHUB_ENV
  #       env:
  #         REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
  #         REACT_APP_STATUS_API_URL: ${{ secrets.REACT_APP_STATUS_API_URL }}
  #         REACT_APP_SERVER_STATUS_URL: ${{ secrets.REACT_APP_SERVER_STATUS_URL }}
  #         REACT_APP_SERVER_NAME: ${{ secrets.REACT_APP_SERVER_NAME }}

  #     - name: Build and push frontend image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./frontend
  #         push: true
  #         tags: ${{ steps.meta-frontend.outputs.tags }}
  #         labels: ${{ steps.meta-frontend.outputs.labels }}
  #         build-args: |
  #           REACT_APP_API_URL=${{ env.REACT_APP_API_URL }}
  #           REACT_APP_STATUS_API_URL=${{ env.REACT_APP_STATUS_API_URL }}
  #           REACT_APP_SERVER_STATUS_URL=${{ env.REACT_APP_SERVER_STATUS_URL }}
  #           REACT_APP_SERVER_NAME=${{ env.REACT_APP_SERVER_NAME }}
  #         cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache
  #         cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:buildcache,mode=max


